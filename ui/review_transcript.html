<!DOCTYPE html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="stylesheet.css">
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-light navbar-dark">
        <a class="navbar-brand">Penn State Undergraduate Application</a>
    </nav>
    <div class="container-fluid" id="review-content">
        <div class="row">
            <p class="w-100 text-center">Please review the information we have gathered from your transcript and make any necessary corrections</p>
        </div>
        <div class="row" id="review-data-row">
            <div class="col-lg-3">
                <h4 class="info-container-title">Your Info</h4>
                <div class="container info-container" id="personal-info">
                    <form>
                        <div class="form-group">
                            <input id="pi-name" class="info-display-text"><br/>
                            <label class="info-display-label" for="pi-name">name</label>
                        </div>
                        <div class="form-group">
                            <input id="pi-address" class="info-display-text"><br/>
                            <label class="info-display-label" for="pi-address">address</label>
                        </div>
                        <div class="form-group">
                            <input id="pi-gpa" class="info-display-text"><br/>
                            <label class="info-display-label" for="pi-gpa">GPA</label>
                        </div>
                        <div class="form-group">
                            <input id="pi-sat-score" class="info-display-text"><br/>
                            <label class="info-display-label" for="pi-sat-score">SAT score</label>
                        </div>
                    </form>
                </div>
                <h4 class="info-container-title">Your High School</h4>
                <div class="container info-container" id="high-school-info">
                    <form>
                        <div class="form-group">
                            <input id="hs-name" class="info-display-text"><br/>
                            <label class="info-display-label" for="hs-name">name</label>
                        </div>
                        <div class="form-group">
                            <input id="hs-address" class="info-display-text"><br/>
                            <label class="info-display-label" for="hs-address">address</label>
                        </div>
                        <div class="form-group">
                            <input id="hs-phone" class="info-display-text"><br/>
                            <label class="info-display-label" for="hs-phone">phone</label>
                        </div>
                        <div class="form-group">
                            <input id="hs-ceeb" class="info-display-text"><br/>
                            <label class="info-display-label" for="hs-ceeb">CEEB Code</label>
                        </div>
                    </form>
                </div>
            </div>
            <div class="col-lg-9">
                <div id="review-classes-container" class="container-fluid">
                    <div class="row">
                        <h4 class="w-100">Your Classes<hr/></h4>
                    </div>
                    <div class="container-fluid" id="all-class-container">
                        <div class="row" id="class-listing-container">
                            <!-- Classes are appended here by script as they are created-->
                        </div>
                        <div class="row">
                            <button type="button" class="btn btn-outline-success ml-auto mr-2"><span class="material-icons">add</span></button>
                        <button type="button" class="btn btn-outline-primary" id="submit-classes-button">Submit >>></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirm-upload-modal">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirm Submission</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <h6>Are you are all classes are listed accurately?</h6>
                    <button id="deny-submit-button" class="btn btn-outline-danger">No</button>
                    <button id="confirm-submit-button" class="btn btn-outline-success">Yes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="uploading-modal">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="d-flex justify-content-center">
                        <span class="spinner-border text-dark" role="status"></span>
                    </div>
                    <h4 class="w-100 text-center mt-2">Uploading submission...</h4>
                </div>
            </div>
        </div>
    </div>
    <script src="js/utils.js"></script>
    <script src="js/posts.js"></script>
    <script src="js/grab.js"></script>
    <script>
        let classListContainer = $('#class-listing-container');
        let submitButton = $('#submit-classes-button');
        let expected_fields = [];
        let classes_record_list = [];
        let actual_fields = [];
        let generic_courses = [];
        $(document).ready(function(){
            let classes = JSON.parse(sessionStorage.getItem("parseResult"));
            generic_courses = classes.genericCourses.subjects;
            //Set the personal information column DOM
            prototypePersonalInfo();
            //parsePersonalInformation(ocrJson);
            //Create the year blocks in the class review DOM
            parseSchoolYears(classes);
            submitButton.click(handleSubmit);
            $('#deny-submit-button').click(handleDenySubmit);
            $('#confirm-submit-button').click(handleConfirmSubmit);
        });

        let prototypePersonalInfo = function(){
            $('#pi-name').val(sessionStorage.getItem("name"));
            $('#pi-address').val(sessionStorage.getItem("address"));
            $('#pi-gpa').val(sessionStorage.getItem("gpa"));
            $('#pi-sat-score').val(sessionStorage.getItem("sat"));
            $('#hs-name').val(sessionStorage.getItem("hs-name"));
            $('#hs-address').val(sessionStorage.getItem("hs-address"));
            $('#hs-phone').val(sessionStorage.getItem("hs-phone"));
        };

        let parseSchoolYears = function(ocrJson){
            let years = ocrJson.classYears;
            //Load the year listing prototype fragment
            let yearPrototype = $('<div class="container-fluid year-listing"></div>');
            yearPrototype.load("frags/year-listing.html", function(){
                //Create a clone of the year listing fragment for each defined year
                for(let i = 0; i < years.length; i++){
                    let thisYear = years[i];
                    addYearListing(thisYear, yearPrototype.clone());
                    $(document).on('change', '.class-name', updateClass);
                }
            });
        };

        /**
         * Create an individual year listing
         * @param year the year data object, containing classes taken within a specific school year
         * @param yearDOM the DOM object for the year prototype
         */
        let addYearListing = function(year, yearDOM){
            yearDOM.find('.year-label').text(year.name);
            let classContainer = yearDOM.find('.class-container');
            let classes = year.classes;
            let classPrototype = $('<div class="container-fluid class-listing"></div>');
            classPrototype.load("frags/class-listing.html", function(){
                //Create a clone of the class listing fragment for each defined class within the year
                for(let i = 0; i < classes.length; i++){
                    let thisClass = classes[i];
                    let thisClassListing = createClassListing(thisClass, classPrototype.clone());
                    //Append the entire class (including the container) to the year object
                    thisClassListing.appendTo(classContainer);
                }
                yearDOM.appendTo(classListContainer);
                actual_fields = new Array(expected_fields.length);
            });
        };

        /**
         * Create a class listing DOM object from a specific class and a DOM element
         * @param thisClass class object the listing is being created for
         * @param classDOM class listing prototype object
         * @return class DOM object to be appended to the year container
         */
        let createClassListing = function(thisClass, classDOM){
            expected_fields.push({
                name: thisClass.name,
                grade: thisClass.grade,
                credits: thisClass.credits
            });
            classDOM.find('.class-name').val(thisClass.name);
            classDOM.find('.class-grade').val(thisClass.grade);
            classDOM.find('.class-credits').val(thisClass.credits);
            classDOM.find('.class-weight').val(thisClass.weight);
            populateCourseOptions(classDOM, thisClass);
            classDOM.data('index', classes_record_list.length);
            classes_record_list.push(classDOM);
            return classDOM;
        };

        let populateCourseOptions = function(classDOM, thisClass){
            let subjectSelect = classDOM.find('.info-display-generic-course-subject');
            let courseSelect = classDOM.find('.info-display-generic-course-name');
            //Iterate through each of the subjects
            for(let i = 0; i < generic_courses.length; i++){
                let thisSubject = generic_courses[i];
                let thisSubjectOption = $('<option></option>');
                thisSubjectOption.attr("value", thisSubject.code);
                thisSubjectOption.text(thisSubject.name);
                thisSubjectOption.appendTo(subjectSelect);
                let thisSubjectCourses = thisSubject.courses;
                for(let j = 0; j < thisSubjectCourses.length; j++){
                    let thisCourse = thisSubjectCourses[j];
                    let thisCourseOption = $('<option></option>');
                    thisCourseOption.attr("value", thisCourse.code);
                    thisCourseOption.text(thisCourse.name);
                    if(thisCourse.name === thisClass.generic_name){
                        courseSelect.find('option').prop("selected", false);
                        thisCourseOption.prop("selected", true);
                        courseSelect.prop("disabled", false);
                        subjectSelect.find('.default-option').prop("selected", false);
                        subjectSelect.find('option[value="' + thisSubject.code + '"').prop("selected", true);
                    }
                    thisCourseOption.appendTo(courseSelect);
                }
            }
        };

        /**
         * Retrieve the personal information from the transcript OCR result
         * @param ocrJson JSON object return from the backend
         */
        let parsePersonalInformation = function(ocrJson){
            let student = ocrJson.student;
            let highSchool = ocrJson.highSchool;
            displayStudentData(student);
            displayHighSchoolData(highSchool);
        };

        /**
         * Set the student information to the DOM
         * @param student object containing the returned student data
         */
        let displayStudentData = function(student){
            $('#pi-name').val(student.name);
            $('#pi-address').val(student.address);
            $('#pi-gpa').val(student.gpa);
            $('#pi-sat-score').val(student.sat);
        };

        /**
         * Set the high school information to the DOM
         * @param highSchool high school object containing the returned high school data
         */
        let displayHighSchoolData = function(highSchool){
            $('#hs-name').val(highSchool.name);
            $('#hs-address').val(highSchool.address);
            $('#hs-phone').val(highSchool.phone);
            $('#hs-ceeb').val(highSchool.ceeb);
        };

        let updateClass = function(e) {
            let sender = $(e.target).parents().eq(4);
            let senderIndex = sender.data('index');
            actual_fields[senderIndex] = {
                name: sender.find('.class-name').val(),
                grade: sender.find('.class-grade').val(),
                credits: sender.find('.class-credits').val()
            };
        };

        /**
         * Handle the clicking of the submit button
         */
        let handleSubmit = function(){
            //Show the confirmation dialog
            $('#confirm-upload-modal').modal();
        };

        /**
         * Handle the click of the 'no i want to go back' button
         */
        let handleDenySubmit = function(){
            //Make the confirmation dialog go away
            $('#confirm-upload-modal').modal("hide");
        };

        /**
         * Handle the submission process ~ clicking of the confirm submit button
         */
        let handleConfirmSubmit = function(){
            $('#confirm-upload-modal').modal("hide");
            $('#uploading-modal').modal();
            //TODO: WORK AROUND ~ NOT IMPLEMENTED INTO WORK FLOW
            let user = {
                firstname: "SAMPLE",
                lastname: "PERSON",
                hs_name: "STATE COLLEGE HIGH SCHOOL",
                ceeb_code: "000000"
            };
            let fields = [];
            let file = sessionStorage.getItem("file");
            for(let i = 0; i < actual_fields.length; i++){
                fields.push({
                    expected: expected_fields[i],
                    actual: actual_fields[i] === undefined ? expected_fields[i] : actual_fields[i],
                    isValid: actual_fields[i] === undefined
                });
            }
            sendSubmissionPost(user, fields, file, handleSubmitComplete);
        };

        /**
         * Handle the submission of the final class records to the data system
         */
        let handleSubmitComplete = function(parseReturn){
            $('#uploading-modal').modal("hide");
            //TODO: actual forms here to do whatever happens next in the workflow
            if(parseReturn.success){
                alert("Successfully submitted high school transcript");
            } else {
                alert("There was a problem uploading your transcript");
            }
        };
    </script>
</body>